import { debugNs } from "../../logger/ns.js";
import { calcBloodpoolExtras } from "./calc-bloodpool-extras.js";

const { debug, warn, error } = debugNs("vampire:bloodpool:inject");

const MARKER_ATTR = "data-rb-hr";
const MARKER_VALUE = "bloodpool-extras";

function removeExisting(html) {
  html.find(`[${MARKER_ATTR}="${MARKER_VALUE}"]`).remove();
}

/**
 * Injects derived Blood Pool information under the system-rendered Blood Pool block.
 *
 * We do NOT patch system templates. We only operate at the DOM level on re-render.
 *
 * Target (upstream):
 * - The Vampire sheet renders Blood Pool via a helper that prints:
 *   - a headline with `.sheet-headline[data-key="bloodpool"]`
 *   - an informational line under the track: `div.information-area.centerText`
 *     (shows "Per turn: X").
 *
 * We insert our two lines right after that existing informational line.
 *
 * Requirements:
 * - Idempotent: sheets re-render often.
 * - All visible text must come from localization.
 * - Font size = 12px, color = grey like upstream information-area.
 *
 * @param {Application} app
 * @param {JQuery} html
 */
export function injectBloodpoolExtras(app, html) {
  try {
    removeExisting(html);

    const actor = app?.actor;
    if (!actor) return;

    // Find the Blood Pool headline generated by the system helper.
    const headline = html.find('.sheet-headline[data-key="bloodpool"]').first();
    if (!headline.length) {
      debug("Bloodpool headline not found; skipping injection", { actorId: actor?.id });
      return;
    }

    // The helper output and the info line share the same parent.
    const block = headline.parent();
    if (!block?.length) {
      warn("Cannot locate bloodpool block parent; skipping injection", { actorId: actor?.id });
      return;
    }

    // Anchor: the already existing informational line under Blood Pool ("Per turn: X").
    const perTurnInfo = block.find("div.information-area.centerText").first();
    if (!perTurnInfo.length) {
      warn("Per-turn info line not found under bloodpool; skipping injection", { actorId: actor?.id });
      return;
    }

    const { wakeCost, hunger } = calcBloodpoolExtras(actor);

    const wakeText = game.i18n.format("rusbar.homerules.vampire.bloodpool.wakeCost", { value: wakeCost });
    const hungerText = game.i18n.format("rusbar.homerules.vampire.bloodpool.hunger", { value: hunger });

    // Keep upstream look (`information-area`) but enforce font-size as requested.
    const wrapper = $(`<div ${MARKER_ATTR}="${MARKER_VALUE}"></div>`);
    wrapper.append(`<div class="information-area centerText" style="font-size: 12px;">${wakeText}</div>`);
    wrapper.append(`<div class="information-area centerText" style="font-size: 12px;">${hungerText}</div>`);

    perTurnInfo.after(wrapper);

    debug("Injected bloodpool extra info", { actorId: actor?.id, wakeCost, hunger });
  } catch (err) {
    error("Failed to inject bloodpool extras", err);
  }
}
